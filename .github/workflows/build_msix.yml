name: Windows

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘å‘å¸ƒæµç¨‹

permissions:
  contents: write
  pull-requests: read # è¯»å– PR ä¿¡æ¯éœ€è¦è¿™ä¸ªæƒé™

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Conan
        run: pip install conan

      - name: Configure Conan Profile
        shell: powershell
        run: |
          conan profile detect --force
          $profilePath = conan profile path default
          Write-Host "Profile path: $profilePath"
          (Get-Content $profilePath) -replace 'compiler\.cppstd=\d+', 'compiler.cppstd=20' | Set-Content $profilePath
          Get-Content $profilePath

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.8.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qtmultimedia qt5compat qtshadertools'

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: 'x64'
          vsversion: '2022'
          sdk: "10.0.26100.0"

      - name: Decode Signing Certificate
        id: write_file
        shell: powershell
        run: |
          $base64String = "${{ secrets.SIGNING_CERT_BASE64 }}"
          $certByteArray = [System.Convert]::FromBase64String($base64String)
          [IO.File]::WriteAllBytes("certificate.pfx", $certByteArray)

      - name: Configure CMake
        run: >
          cmake --preset FMusic-release -DENABLE_WINRT=ON

      - name: Build
        run: cmake --build --preset release --parallel

      - name: Install to dist
        run: cmake --build build\FMusic-release --target install

      - name: Create MSIX Package
        run: |
          makepri.exe new /pr "dist" /cf "dist\priconfig.xml" /OutputFile "dist"
          MakeAppx pack /d "dist" /p "FMusic.msix"

      - name: Sign MSIX Package
        run: |
          SignTool sign /fd SHA256 /a /f "certificate.pfx" /p "${{ secrets.SIGNING_CERT_PASSWORD }}" "FMusic.msix"

      - name: Rename Release Asset
        run: |
          Rename-Item -Path "FMusic.msix" -NewName "FMusic-${{ github.ref_name }}-Windows-x64.msix"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FMusic-${{ github.ref_name }}-Windows-x64.zip
          path: FMusic-${{ github.ref_name }}-Windows-x64.msix
          compression-level: 0
      
      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          commitMode: true
          # é…ç½®ç”Ÿæˆçš„æ ·å¼
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## ğŸš€ Features",
                    "labels": ["^feature", "^enhancement", "^feat"]
                },
                {
                    "title": "## ğŸ› Fixes",
                    "labels": ["^fix", "^bug", "^patch"]
                },
                {
                    "title": "## ğŸ›  Refactor & Perf",
                    "labels": ["^refactor", "^perf", "^style", "^chore"]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3. å‘å¸ƒ Release (åˆå¹¶æ‰‹åŠ¨æ–‡æ¡ˆ + è‡ªåŠ¨æ—¥å¿—)
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: FMusic-${{ github.ref_name }}-Windows-x64.msix
          # è¿™é‡Œæ‹¼æ¥ä½ çš„â€œå›ºå®šè¥é”€æ–‡æ¡ˆâ€å’Œâ€œè‡ªåŠ¨ç”Ÿæˆçš„æ—¥å¿—â€
          body: |
            # ğŸ‰ FMusic ${{ github.ref_name }} Update
            
            Welcome to the new version of FMusic! This update brings a modern UI and better performance.
            
            ---
            
            ${{ steps.build_changelog.outputs.changelog }}
          draft: false
          prerelease: false
